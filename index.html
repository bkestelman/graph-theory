<html>
<head>
	<meta charset="utf-8">
	<style type="text/css">
		canvas { 
			border: 1px solid black;
		}
	</style>
</head>
<body>
	<div>
		<canvas id="canvas" width="1000" height="600">Error creating canvas</canvas>
	</div>
	<script src="sock-server/node_modules/socket.io-client/dist/socket.io.js"></script>
	<script src="scripts/simplegraph.js"></script>
	<script src="scripts/canvasgraph.js"></script>
	<script>
	var CG = CanvasGraph(SimpleGraph)
	var graph = new CG.CanvasGraph()
	var graph2 = new CG.CanvasGraph()
	var canvas = document.getElementById('canvas')
	var ctx = canvas.getContext('2d')
	var mousex, mousey

	canvas.addEventListener('click', function(event) {
		console.log('click')
		var x = event.offsetX
		var y = event.offsetY 
		var clickedV = graph.getV(x, y) 
		if (clickedV) { // if we clicked an existing Vertex
			if (graph.drawer.lastDrawn) {
				broadcast({ close: clickedV }) 
				var newe = graph.close(clickedV) // "close" the graph
			}
			else { 
				graph.drawer.lastDrawn = clickedV
			}
		}
		else { // otherwise add a new Vertex
			var newv = new CG.CanvasVertex(x, y)
			broadcast({ addV: newv })
			graph.addV(newv) 
		}
		//redraw()
	})
	canvas.addEventListener('contextmenu', function(event) { // right click
		event.preventDefault() // don't open menu
		console.log('right click')
		var x = event.offsetX
		var y = event.offsetY 
		var clickedV = graph.getV(x, y)
		broadcast({ delV: clickedV })
		graph.delV(clickedV)
		//redraw()
		return false
	})
	canvas.addEventListener('mousemove', function(event) {
		mousex = event.offsetX
		mousey = event.offsetY
		//redraw()
	})

	function redraw() {
		ctx.clearRect(0, 0, canvas.width, canvas.height)
		graph.draw()
		window.requestAnimationFrame(redraw) // really, we should only call this when the graph is changed (on click or on update)
	}
	window.requestAnimationFrame(redraw) 

	// Socket stuff
	var socket = io('192.81.214.140:5000')
	socket.on('update', function(update) {
		console.log(update)
		if (update.drawer.lastDrawn) {
			update.drawer.lastDrawn = graph.getV(update.drawer.lastDrawn.x, update.drawer.lastDrawn.y)
		}
		if (update.addV) {
			graph.addV( new CG.CanvasVertex(update.addV.x, update.addV.y), update.drawer )
		}
		else if (update.close) {
			update.close = graph.getV(update.close.x, update.close.y) 
			graph.close( update.close, update.drawer )
		}
		else if (update.delV) {
			graph.delV( graph.getV(update.delV.x, update.delV.y) )
		}
	})
	socket.on('init', function(fullgraph) {
		graph = new CanvasGraph(fullgraph) 
	})
	function broadcast(update) {
		update.drawer = graph.drawer
		socket.emit('update', update)
	}
	</script>
</body>
